<!DOCTYPE html>
<html lang="lt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DI Stilistas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4f46e5;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200">

    <div class="container mx-auto px-4 py-8 md:py-16">
        <div class="max-w-4xl mx-auto bg-white dark:bg-gray-800 rounded-2xl shadow-xl overflow-hidden">
            <div class="p-8">
                <!-- Header Section -->
                <div class="text-center mb-8">
                    <h1 class="text-4xl md:text-5xl font-bold text-gray-900 dark:text-white">DI Stilistas</h1>
                    <p class="mt-2 text-gray-600 dark:text-gray-400">Įkelkite iki 3 drabužių (pvz., kelnės, marškiniai), ir DI sukurs vientisą įvaizdį.</p>
                </div>

                <!-- Input Form -->
                <form id="style-form" class="space-y-4 max-w-2xl mx-auto">
                    <div>
                        <label for="image-upload-label" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Įkelkite drabužių ekrano nuotraukas (iki 3)</label>
                        <input type="file" id="image-upload" multiple accept="image/*" class="hidden">
                        <label for="image-upload" id="image-upload-label" class="w-full cursor-pointer inline-flex items-center justify-center px-6 py-4 border-2 border-dashed border-gray-300 dark:border-gray-600 text-sm font-medium rounded-lg text-gray-700 dark:text-gray-300 bg-gray-50 dark:bg-gray-700 hover:bg-gray-100 dark:hover:bg-gray-600 transition">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
                            <span>Pasirinkite failus...</span>
                        </label>
                        <div id="preview-container" class="mt-4 flex gap-4 flex-wrap justify-center"></div>
                        <p class="mt-2 text-xs text-gray-500 dark:text-gray-400 text-center">Visi drabužiai bus sujungti į vieną aprangą.</p>
                    </div>
                    <div class="flex justify-center pt-4">
                        <button type="button" id="submit-button" class="inline-flex items-center justify-center px-8 py-3 border border-transparent text-base font-medium rounded-lg shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition disabled:opacity-50 disabled:cursor-not-allowed">
                           <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><path d="M12 2a2.828 2.828 0 0 0-2 5 2.828 2.828 0 0 0-5 2 2.828 2.828 0 0 0-2 5 2.828 2.828 0 0 0 2 5 2.828 2.828 0 0 0 5 2 2.828 2.828 0 0 0 2-5 2.828 2.828 0 0 0 5-2 2.828 2.828 0 0 0 2-5 2.828 2.828 0 0 0-2-5 2.828 2.828 0 0 0-5-2z"></path><path d="m22 12-2.29 2.29"></path><path d="M2.29 11.71 12 22"></path></svg>
                           <span>Sukurti įvaizdį</span>
                       </button>
                   </div>
                </form>

                <!-- Status/Loader Section -->
                <div id="status-container" class="text-center py-8 hidden">
                    <div class="loader mx-auto"></div>
                    <p id="status-text" class="mt-4 text-lg font-medium text-gray-700 dark:text-gray-300">Apdorojamos jūsų nuotraukos...</p>
                </div>

                <!-- Results Section -->
                <div id="results" class="mt-12 hidden">
                    <h2 class="text-3xl text-center font-bold mb-8 text-gray-900 dark:text-white">Jūsų sukurtas įvaizdis</h2>
                    <div id="processed-image-container" class="max-w-lg mx-auto bg-white dark:bg-gray-800 rounded-lg flex items-center justify-center overflow-hidden border border-gray-200 dark:border-gray-600" style="aspect-ratio: 4/5;">
                        <!-- Processed image will be injected here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const styleForm = document.getElementById('style-form');
        const imageUpload = document.getElementById('image-upload');
        const imageUploadLabel = document.getElementById('image-upload-label');
        const previewContainer = document.getElementById('preview-container');
        const submitButton = document.getElementById('submit-button');
        const statusContainer = document.getElementById('status-container');
        const statusText = document.getElementById('status-text');
        const resultsContainer = document.getElementById('results');
        const processedImageContainer = document.getElementById('processed-image-container');

        // --- API Configuration ---
        const apiKey = ""; // API key is not needed for these models in this environment.
        const imageEditModel = 'gemini-2.5-flash-image-preview';

        // --- Event Listeners ---
        imageUpload.addEventListener('change', () => {
            previewContainer.innerHTML = ''; // Clear previous previews
            const files = imageUpload.files;
            
            if (files.length > 3) {
                showError("Galima įkelti ne daugiau kaip 3 nuotraukas.");
                imageUpload.value = ''; // Reset the input
                imageUploadLabel.querySelector('span').textContent = 'Pasirinkite failus...';
                return;
            }

            if (files && files.length > 0) {
                imageUploadLabel.querySelector('span').textContent = `${files.length} failas(-ai) pasirinkta`;
                Array.from(files).forEach(file => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const img = document.createElement('img');
                        img.src = e.target.result;
                        img.className = 'h-24 w-24 object-cover rounded-lg border border-gray-300';
                        previewContainer.appendChild(img);
                    };
                    reader.readAsDataURL(file);
                });
            } else {
                 imageUploadLabel.querySelector('span').textContent = 'Pasirinkite failus...';
            }
        });

        submitButton.addEventListener('click', async (e) => {
            e.preventDefault();
            const files = imageUpload.files;
            if (!files || files.length === 0) {
                showError("Prašome įkelti bent vieną ekrano nuotrauką.");
                return;
            }

            // 1. Reset UI and show loader
            submitButton.disabled = true;
            resultsContainer.classList.add('hidden');
            processedImageContainer.innerHTML = '';
            statusContainer.classList.remove('hidden');

            try {
                // 2. Convert images to base64
                statusText.textContent = 'Paruošiamos nuotraukos...';
                const base64Images = await readAllFiles(files);

                // 3. STEP 1: Clean each image individually
                statusText.textContent = `Valomi UI elementai... (1/2)`;
                const cleanImagePromises = base64Images.map(imgObject => extractClothingItem(imgObject));
                const cleanedImages = await Promise.all(cleanImagePromises);
                
                // 4. STEP 2: Compose the final outfit from cleaned images
                statusText.textContent = 'Kuriamas bendras įvaizdis... (2/2)';
                const finalImage = await composeOutfit(cleanedImages);

                // 5. Display the final outfit image
                displayProcessedImage(finalImage);
                
                // 6. Show results container
                statusContainer.classList.add('hidden');
                resultsContainer.classList.remove('hidden');

            } catch (error) {
                console.error('Įvyko klaida:', error);
                showError(error.message || "Įvyko nežinoma klaida. Patikrinkite konsolę.");
                statusContainer.classList.add('hidden');
            } finally {
                submitButton.disabled = false;
                imageUpload.value = '';
                previewContainer.innerHTML = '';
                imageUploadLabel.querySelector('span').textContent = 'Pasirinkite failus...';
            }
        });

        // --- Helper Functions ---

        function showError(message) {
            statusContainer.classList.remove('hidden');
            statusText.innerHTML = `<span class="text-red-500">${message}</span>`;
            resultsContainer.classList.add('hidden');
        }

        async function readAllFiles(files) {
            const filePromises = Array.from(files).map(file => {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onloadend = () => resolve({
                        base64: reader.result.split(',')[1],
                        mimeType: reader.result.split(';')[0].split(':')[1]
                    });
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                });
            });
            return await Promise.all(filePromises);
        }
        
        async function fetchWithRetry(url, options, maxRetries = 5) {
            let attempt = 0;
            while (attempt < maxRetries) {
                try {
                    const response = await fetch(url, options);
                    if (response.status === 429 || response.status >= 500) {
                         throw new Error(`Serverio klaida: ${response.status}`);
                    }
                    if (!response.ok) {
                         const errorText = await response.text();
                         throw new Error(`API užklausa nepavyko: ${response.status} ${errorText}`);
                    }
                    return await response.json();
                } catch (error) {
                    attempt++;
                    if (attempt >= maxRetries) {
                        throw error;
                    }
                    const delay = Math.pow(2, attempt) * 1000 + Math.random() * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }
        
        // API Call for STEP 1: Isolate clothing from a single screenshot
        async function extractClothingItem(imageObject) {
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${imageEditModel}:generateContent?key=${apiKey}`;
            const prompt = { text: "CRITICAL TASK: Your only job is to perform a 'digital cutout'. Isolate the main clothing item from the image. You MUST completely remove the background and all user interface (UI) elements (like status bars, buttons, text). The output should be ONLY the clothing item on a pure white background (#FFFFFF)." };
            const payload = {
                contents: [{ parts: [prompt, { inlineData: { mimeType: imageObject.mimeType, data: imageObject.base64 } }] }],
                generationConfig: { responseModalities: ['IMAGE'] },
            };
            const result = await fetchWithRetry(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            const imageData = result?.candidates?.[0]?.content?.parts?.find(p => p.inlineData)?.inlineData;
            if (!imageData || !imageData.data) {
                throw new Error("DI nepavyko iškirpti drabužio.");
            }
            // Return a new object in the same format for the next step
            return { base64: imageData.data, mimeType: imageData.mimeType };
        }

        // API Call for STEP 2: Combine cleaned images into an outfit
        async function composeOutfit(cleanedImageObjects) {
             const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${imageEditModel}:generateContent?key=${apiKey}`;
             const prompt = { text: "You are provided with several pre-cleaned images of clothing items against a white background. Combine these items into a single, cohesive outfit. Create ONE photorealistic image of this full outfit worn by an invisible 'ghost' mannequin. Place the final composition against a seamless, pure white studio background (#FFFFFF). The result should be a high-quality, professional-looking product shot of the full outfit." };
             const imageParts = cleanedImageObjects.map(img => ({
                inlineData: { mimeType: img.mimeType, data: img.base64 }
            }));
            const payload = {
                contents: [{ parts: [prompt, ...imageParts] }],
                generationConfig: { responseModalities: ['IMAGE'] },
            };

            const result = await fetchWithRetry(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            const imageData = result?.candidates?.[0]?.content?.parts?.find(p => p.inlineData)?.inlineData;
            if (!imageData || !imageData.data) {
                throw new Error("DI nepavyko sugeneruoti galutinio įvaizdžio.");
            }
            return imageData.data;
        }


        function displayProcessedImage(base64Data) {
            processedImageContainer.innerHTML = ''; // Clear previous results
            // Change background of container to white for better presentation
            processedImageContainer.classList.remove('bg-gray-100', 'dark:bg-gray-700');
            processedImageContainer.classList.add('bg-white');

            const img = document.createElement('img');
            img.src = `data:image/png;base64,${base64Data}`;
            img.alt = 'Sukurtas įvaizdis ant nematomo modelio';
            img.className = 'w-full h-full object-contain';
            processedImageContainer.appendChild(img);
        }

    </script>
</body>
</html>

